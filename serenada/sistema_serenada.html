<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Serenada Pub & Burger - Sistema</title>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#121212;
    color:#fff;
}

.container{
    max-width:1100px;
    margin:30px auto;
    background:#1e1e1e;
    padding:25px;
    border-radius:12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}

h1{
    text-align:center;
    color: #03dac6;
}

.section{
    margin-top:30px;
    padding:15px;
    background:#2a2a2a;
    border-radius:10px;
}

input, select{
    padding:8px;
    margin:5px;
    border-radius: 4px;
    border: 1px solid #444;
    background: #333;
    color: #fff;
}

button{
    padding:8px 12px;
    margin:5px;
    cursor:pointer;
    border:none;
    border-radius:6px;
    font-weight: bold;
    transition: 0.3s;
}

button:hover { opacity: 0.8; }

.btn-primary{ background:#03dac6; color: #000; }
.btn-danger{ background:#ff5252; color:#fff; }
.btn-close{ background:#ff4081; color:#fff; }
.btn-warning { background: #ffb100; color: #000; }

table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
}

th, td{
    border-bottom:1px solid #444;
    padding:10px;
    text-align:center;
}

th { background: #333; }

.total{
    font-weight:bold;
    margin-top:15px;
    font-size: 1.2em;
    color: #03dac6;
}

.obs-text {
    font-size: 0.85em;
    color: #bbb;
    font-style: italic;
}

#campoCliente { display: none; } /* Escondido por padr√£o */
</style>
</head>
<body>

<div id="loginScreen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#121212; display:flex; justify-content:center; align-items:center; flex-direction:column; z-index:9999;">
    <h2>üîê Acesso ao Sistema</h2>
    <input type="password" id="senhaLogin" placeholder="Digite a senha">
    <button class="btn-primary" onclick="fazerLogin()">Entrar</button>
</div>

<div class="container">
    <h1>Serenada Pub & Burger</h1>

    <div class="section">
        <h3>üì¶ Cadastro de Produtos / Estoque</h3>
        <input id="nomeProduto" placeholder="Nome do Produto">
        <input id="precoProduto" type="number" step="0.01" min="0.01" placeholder="Pre√ßo R$">
        <input id="estoqueProduto" type="number" min="0" placeholder="Qtd Inicial">
        <button class="btn-primary" onclick="cadastrarProduto()">Cadastrar Produto</button>

        <table>
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Pre√ßo</th>
                    <th>Estoque Atual</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tabelaEstoque"></tbody>
        </table>
    </div>

    <div class="section">
        <h3>üî• Lan√ßar Pedido</h3>
        <select id="mesaSelect" onchange="toggleCliente()"></select>
        
        <span id="campoCliente">
            <input type="text" id="nomeCliente" placeholder="Nome do Cliente (Delivery)">
        </span>

        <select id="produtoSelect"></select>
        <input type="number" id="qtdItem" placeholder="Qtd" value="1" min="1" style="width: 60px;">
        <input type="text" id="obsItem" placeholder="Observa√ß√£o">
        <button class="btn-primary" onclick="adicionarItem()">Adicionar Item</button>

        <table>
            <thead>
                <tr>
                    <th>Local/Cliente</th>
                    <th>Produto</th>
                    <th>Obs</th>
                    <th>Qtd</th>
                    <th>Total</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="itensMesa"></tbody>
        </table>

        <div class="total" id="totalMesa">Total: R$ 0.00</div>
        <button class="btn-close" onclick="fecharMesa()">Finalizar e Fechar Pedido</button>
    </div>

    <div class="section">
        <h3>üí∞ Painel do Caixa</h3>
        <div id="totalDia" style="font-size: 1.5em; margin: 10px 0;">Total do Dia: R$ 0.00</div>
        <button class="btn-danger" onclick="fecharCaixa()">Encerrar Caixa (TXT)</button>
        <button class="btn-primary" onclick="gerarRelatorioCompleto()">üìä Relat√≥rio do Dia</button>
        <button class="btn-warning" onclick="zerarSistema()">‚ö†Ô∏è Zerar Tudo (Senha)</button>
    </div>
</div>

<script>
const SENHA_SISTEMA = "1234"; 

let estoque = JSON.parse(localStorage.getItem("estoque")) || [];
let comandas = JSON.parse(localStorage.getItem("comandas")) || {};
let totalDia = JSON.parse(localStorage.getItem("totalDia")) || 0;

function fazerLogin(){
    let senha = document.getElementById("senhaLogin").value;
    if(senha === SENHA_SISTEMA) document.getElementById("loginScreen").style.display="none";
    else alert("Senha incorreta!");
}

function salvarDados(){
    localStorage.setItem("estoque", JSON.stringify(estoque));
    localStorage.setItem("comandas", JSON.stringify(comandas));
    localStorage.setItem("totalDia", JSON.stringify(totalDia));
}

// Mostra/Esconde campo de nome do cliente se for Delivery
function toggleCliente() {
    let mesa = mesaSelect.value;
    document.getElementById("campoCliente").style.display = (mesa === "Delivery") ? "inline-block" : "none";
    atualizarMesa();
}

function cadastrarProduto(){
    let nome = nomeProduto.value.trim();
    let preco = parseFloat(precoProduto.value);
    let qtd = parseInt(estoqueProduto.value);

    // Valida√ß√£o de negativos e vazios
    if(!nome || isNaN(preco) || isNaN(qtd)){
        return alert("Preencha todos os campos corretamente.");
    }
    if(preco <= 0){
        return alert("O pre√ßo deve ser maior que zero!");
    }
    if(qtd < 0){
        return alert("A quantidade inicial n√£o pode ser negativa!");
    }

    let duplicado = estoque.find(p => p.nome.toLowerCase() === nome.toLowerCase());
    if(duplicado) return alert("‚ùå Este produto j√° est√° cadastrado!");

    estoque.push({nome, preco, qtd});
    salvarDados();
    atualizarEstoque();

    nomeProduto.value = ""; precoProduto.value = ""; estoqueProduto.value = "";
}

function excluirProduto(index) {
    if(confirm(`Excluir "${estoque[index].nome}" permanentemente?`)) {
        estoque.splice(index, 1);
        salvarDados();
        atualizarEstoque();
    }
}

function atualizarEstoque(){
    tabelaEstoque.innerHTML="";
    produtoSelect.innerHTML="";
    estoque.forEach((p,i)=>{
        tabelaEstoque.innerHTML+=
        `<tr>
            <td>${p.nome}</td>
            <td>R$ ${p.preco.toFixed(2)}</td>
            <td>
                <button onclick="alterarEstoque(${i}, -1)">‚ûñ</button>
                ${p.qtd}
                <button onclick="alterarEstoque(${i}, 1)">‚ûï</button>
            </td>
            <td><button class="btn-danger" onclick="excluirProduto(${i})">üóëÔ∏è</button></td>
        </tr>`;
        produtoSelect.innerHTML+= `<option value="${i}">${p.nome}</option>`;
    });
}

function alterarEstoque(index, quantidade){
    let produto = estoque[index];
    if(produto.qtd + quantidade < 0) return alert("O estoque n√£o pode ficar negativo!");
    produto.qtd += quantidade;
    salvarDados();
    atualizarEstoque();
}

function atualizarMesas(){
    mesaSelect.innerHTML = `<option value="todas">Ver Todas</option>`;
    mesaSelect.innerHTML += `<option value="Balc√£o">üìç Balc√£o</option>`;
    mesaSelect.innerHTML += `<option value="Delivery">üõµ Delivery</option>`;
    for(let i=1;i<=20;i++) mesaSelect.innerHTML += `<option value="${i}">Mesa ${i}</option>`;
}

function adicionarItem(){
    let mesa = mesaSelect.value;
    if(mesa==="todas") return alert("Selecione um destino");

    let nomeCli = document.getElementById("nomeCliente").value.trim();
    if(mesa === "Delivery" && !nomeCli) return alert("Informe o nome do cliente para o Delivery!");

    let produtoIndex = produtoSelect.value;
    let qtd = parseInt(qtdItem.value);
    let obs = obsItem.value.trim();

    if(isNaN(qtd) || qtd <= 0) return alert("Quantidade inv√°lida!");

    let produto = estoque[produtoIndex];
    if(!produto) return alert("Produto n√£o encontrado");
    if(produto.qtd < qtd) return alert("Estoque insuficiente!");

    // Identificador √∫nico da comanda (se for delivery, usa o nome do cliente para separar)
    let idComanda = (mesa === "Delivery") ? `Delivery - ${nomeCli}` : mesa;

    if(!comandas[idComanda]) comandas[idComanda]=[];

    comandas[idComanda].push({
        nome: produto.nome,
        qtd,
        preco: produto.preco,
        total: produto.preco * qtd,
        obs: obs,
        cliente: (mesa === "Delivery") ? nomeCli : null
    });

    produto.qtd -= qtd;
    obsItem.value = "";
    salvarDados();
    atualizarEstoque();
    atualizarMesa();
}

function atualizarMesa(){
    let mesaSel = mesaSelect.value;
    let nomeCli = document.getElementById("nomeCliente").value.trim();
    let idBusca = (mesaSel === "Delivery") ? `Delivery - ${nomeCli}` : mesaSel;
    
    itensMesa.innerHTML="";
    let total=0;

    if(mesaSel === "todas"){
        for(let id in comandas){
            itensMesa.innerHTML+= `<tr><td colspan="6" style="background:#333"><b>Destino: ${id}</b></td></tr>`;
            comandas[id].forEach(item => {
                total += item.total;
                itensMesa.innerHTML += `<tr><td>${id}</td><td>${item.nome}</td><td class="obs-text">${item.obs || "-"}</td><td>${item.qtd}</td><td>R$ ${item.total.toFixed(2)}</td><td></td></tr>`;
            });
        }
    } else if(comandas[idBusca]){
        comandas[idBusca].forEach((item, index) => {
            total += item.total;
            itensMesa.innerHTML += `<tr><td>${idBusca}</td><td>${item.nome}</td><td class="obs-text">${item.obs || "-"}</td><td>${item.qtd}</td><td>R$ ${item.total.toFixed(2)}</td>
            <td><button class="btn-danger" onclick="removerItem('${idBusca}',${index})">‚ùå</button></td></tr>`;
        });
    }
    totalMesa.innerHTML="Total: R$ "+total.toFixed(2);
}

function removerItem(id, index){
    let item = comandas[id][index];
    let produto = estoque.find(p=>p.nome===item.nome);
    if(produto) produto.qtd += item.qtd;
    comandas[id].splice(index,1);
    if(comandas[id].length===0) delete comandas[id];
    salvarDados();
    atualizarEstoque();
    atualizarMesa();
}

function fecharMesa(){
    let mesaSel = mesaSelect.value;
    let nomeCli = document.getElementById("nomeCliente").value.trim();
    let idBusca = (mesaSel === "Delivery") ? `Delivery - ${nomeCli}` : mesaSel;

    if(mesaSel==="todas" || !comandas[idBusca]) return alert("Selecione um pedido aberto.");

    let pagamento = prompt("Pagamento:\n1-Dinheiro\n2-Pix\n3-Cr√©dito\n4-D√©bito");
    let formas = {"1":"Dinheiro", "2":"Pix", "3":"Cr√©dito", "4":"D√©bito"};
    if(!formas[pagamento]) return alert("Opera√ß√£o cancelada.");

    let total = comandas[idBusca].reduce((s,i)=>s+i.total,0);
    let registro = {
        destino: idBusca,
        itens: [...comandas[idBusca]],
        total,
        formaPagamento: formas[pagamento],
        data: new Date().toISOString()
    };

    let historico = JSON.parse(localStorage.getItem("historico")) || [];
    historico.push(registro);
    localStorage.setItem("historico", JSON.stringify(historico));

    totalDia += total;
    imprimirCupom(idBusca, comandas[idBusca], total);
    delete comandas[idBusca];
    document.getElementById("nomeCliente").value = "";

    salvarDados();
    atualizarMesa();
    atualizarTotalDia();
}

function imprimirCupom(id, itens, total){
    let janela = window.open("", "", "width=300,height=600");
    let conteudo = `<pre>SERENADA PUB & BURGER\nPedido: ${id}\n--------------------------\n`;
    itens.forEach(i=>{
        conteudo += `${i.nome}\n${i.qtd}x${i.preco.toFixed(2)}=${i.total.toFixed(2)}\n`;
        if(i.obs) conteudo += ` * Obs: ${i.obs}\n`;
    });
    conteudo += `--------------------------\nTOTAL: R$ ${total.toFixed(2)}\n\nObrigado!</pre>`;
    janela.document.write(conteudo);
    janela.print();
    janela.close();
}

function zerarSistema() {
    let senha = prompt("Senha de administrador:");
    if(senha === SENHA_SISTEMA) {
        if(confirm("Deseja apagar comandas, hist√≥rico e caixa do dia?")) {
            comandas = {}; totalDia = 0;
            localStorage.removeItem("historico");
            salvarDados(); location.reload();
        }
    } else alert("Senha incorreta!");
}

function atualizarTotalDia(){
    document.getElementById("totalDia").innerHTML="Total do Dia: R$ "+totalDia.toFixed(2);
}

function fecharCaixa(){
    if(totalDia === 0) return alert("Caixa zerado.");
    let relatorio = `SERENADA PUB & BURGER\nDATA: ${new Date().toLocaleString()}\nTOTAL: R$ ${totalDia.toFixed(2)}`;
    let blob = new Blob([relatorio], { type: "text/plain" });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `caixa.txt`;
    link.click();
}

function gerarRelatorioCompleto(){
    let historico = JSON.parse(localStorage.getItem("historico")) || [];
    let texto = "RELAT√ìRIO DE VENDAS\n\n";
    historico.forEach(reg => {
        texto += `${new Date(reg.data).toLocaleString()} - ${reg.destino} - R$ ${reg.total.toFixed(2)} (${reg.formaPagamento})\n`;
    });
    let blob = new Blob([texto], { type: "text/plain" });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "vendas.txt";
    link.click();
}

atualizarEstoque();
atualizarMesas();
atualizarTotalDia();
</script>
</body>
</html>
